<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuteur Anglais FWB</title>
    <style>
        :root { --p: #2C3E50; --s: #3498DB; --a: #E67E22; --bg: #F4F7F6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; height: 100vh; }
        .app { width: 100%; max-width: 500px; background: white; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        header { background: var(--p); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .settings { padding: 10px; background: #eee; display: flex; gap: 10px; }
        .topics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; border-bottom: 2px solid #ddd; }
        .t-btn { font-size: 0.7rem; padding: 8px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background: white; }
        .t-btn.active { background: var(--s); color: white; }
        #chat { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 15px; line-height: 1.4; }
        .user { align-self: flex-end; background: var(--s); color: white; }
        .ai { align-self: flex-start; background: #f0f0f0; border: 1px solid #ddd; }
        .err { background: #fee; color: red; align-self: center; font-size: 0.8rem; }
        .controls { padding: 20px; text-align: center; border-top: 1px solid #eee; }
        #mic { width: 60px; height: 60px; border-radius: 50%; border: none; background: #e74c3c; color: white; font-size: 1.5rem; cursor: pointer; }
        #mic.active { background: #27ae60; animation: p 1s infinite; }
        @keyframes p { 0% { box-shadow: 0 0 0 0 rgba(39,174,96,0.5); } 70% { box-shadow: 0 0 0 10px rgba(39,174,96,0); } }
    </style>
</head>
<body>

<div class="app">
    <header>
        <button onclick="askKey()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">‚öôÔ∏è</button>
        <b>English Tutor üáßüá™</b>
        <span>‚≠ê <span id="sc">0</span></span>
    </header>

    <div class="settings">
        <select id="lvl">
            <option value="A1">Primaire (A1)</option>
            <option value="A2.1">S1-S2 (A2.1)</option>
            <option value="A2.2">S3 (A2.2)</option>
        </select>
    </div>

    <div class="topics" id="t-grid"></div>
    <div id="chat">
        <div class="msg ai">Hello! Clique sur ‚öôÔ∏è pour ajouter ta cl√©, puis sur le micro.</div>
    </div>

    <div class="controls">
        <button id="mic">üé§</button>
        <p id="st">Clique pour parler</p>
    </div>
</div>

<script>
    const FIELDS = [
        { n: 'Moi', e: 'üë§' }, { n: 'Maison', e: 'üè†' }, { n: 'Hobbies', e: '‚öΩ' }, 
        { n: 'Voyage', e: 'üö≤' }, { n: 'Sant√©', e: 'üçé' }, { n: 'Food', e: 'üçï' }
    ];
    
    let key = localStorage.getItem('g_key') || "";
    let topic = "Moi";
    let score = 0;

    // Cr√©ation des boutons de th√®mes
    const grid = document.getElementById('t-grid');
    FIELDS.forEach(f => {
        const b = document.createElement('button');
        b.className = 't-btn';
        b.innerHTML = f.e + "<br>" + f.n;
        b.onclick = () => {
            topic = f.n;
            document.querySelectorAll('.t-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
        };
        grid.appendChild(b);
    });

    // Fonction pour l'engrenage (doit √™tre accessible globalement)
    window.askKey = function() {
        const input = prompt("Colle ta cl√© API Gemini ici :", key);
        if (input) {
            key = input.trim();
            localStorage.setItem('g_key', key);
            alert("Cl√© enregistr√©e !");
        }
    };

    // Micro
    const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    rec.lang = 'en-US';

    document.getElementById('mic').onclick = () => {
        if(!key) return askKey();
        rec.start();
        document.getElementById('mic').classList.add('active');
    };

    rec.onresult = (e) => {
        const txt = e.results[0][0].transcript;
        addMsg(txt, 'user');
        callAI(txt);
    };

    rec.onend = () => document.getElementById('mic').classList.remove('active');

 async function callAI(txt) {
        const l = document.getElementById('lvl').value;
        // CHANGEMENT : Passage en version "v1" (stable) au lieu de "v1beta"
        const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${key}`;
        
        const prompt = `Act as an English Tutor for a student (Level ${l}). Topic: ${topic}. Student said: "${txt}". Answer in 1 short sentence, correct errors if any, and ask 1 question. Use very simple English.`;

        try {
            const r = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: prompt }] }] 
                })
            });
            const d = await r.json();
            
            if(d.error) {
                // Si une erreur revient, on l'affiche clairement
                addMsg("Erreur API : " + d.error.message, 'err');
            } else if (d.candidates && d.candidates[0].content) {
                const rep = d.candidates[0].content.parts[0].text;
                addMsg(rep, 'ai');
                const u = new SpeechSynthesisUtterance(rep);
                u.lang = 'en-US';
                window.speechSynthesis.speak(u);
            }
        } catch(e) { 
            addMsg("Erreur de connexion : " + e.message, 'err'); 
        }
    }

    function addMsg(t, cl) {
        const d = document.createElement('div');
        d.className = `msg ${cl}`;
        d.innerText = t;
        document.getElementById('chat').appendChild(d);
        document.getElementById('chat').scrollTop = 9999;
    }
</script>
</body>
</html>
