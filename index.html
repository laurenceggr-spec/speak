<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuteur Anglais - Tronc Commun FWB</title>
    <style>
        :root {
            --primary: #2C3E50; --secondary: #3498DB; --accent: #E67E22;
            --success: #27AE60; --light: #F4F7F6; --error: #E74C3C;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; justify-content: center; height: 100vh; }
        .app-container { width: 100%; max-width: 500px; background: white; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .settings-bar { padding: 10px; background: #eee; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #ddd; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; flex: 1; font-size: 0.9rem; }
        
        .topics-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; 
            background: #fff; border-bottom: 2px solid #ddd;
        }
        .topic-btn { 
            font-size: 0.7rem; padding: 8px 4px; border: 1px solid #ddd; border-radius: 5px; 
            cursor: pointer; background: white; transition: 0.2s; text-align: center;
        }
        .topic-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        #visual-stage { height: 80px; display: flex; align-items: center; justify-content: center; font-size: 3rem; border-bottom: 1px solid #eee; background: #fff; }
        #chat-box { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #fafafa; }
        
        .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.4; position: relative; font-size: 1rem; }
        .user { align-self: flex-end; background: var(--secondary); color: white; border-bottom-right-radius: 2px; }
        .ai { align-self: flex-start; background: white; border: 1px solid #ddd; color: #333; border-bottom-left-radius: 2px; }
        .error-msg { background: #FDEDEC; color: var(--error); border: 1px solid var(--error); align-self: center; font-size: 0.8rem; }
        
        .word-bank { padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; border-top: 1px solid #eee; background: white; min-height: 40px; }
        .word-tag { background: #E8F6F3; color: #16A085; padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; border: 1px solid #D1F2EB; }

        .controls { padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; border-top: 1px solid #eee; background: white; }
        #mic-btn { width: 70px; height: 70px; border-radius: 50%; border: none; background: var(--error); color: white; font-size: 1.8rem; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #mic-btn.listening { background: var(--success); transform: scale(1.1); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(39,174,96, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(39,174,96, 0); } }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <span onclick="toggleSettings()" style="cursor:pointer; font-size: 1.5rem;">‚öôÔ∏è</span>
        <div style="font-weight: bold; font-size: 1.2rem;">My English Tutor üáßüá™</div>
        <div id="score-display">‚≠ê <span id="score-val">0</span></div>
    </header>

    <div class="settings-bar">
        <label for="level-select">üéØ</label>
        <select id="level-select">
            <option value="A1 (P3-P6)">Niveau P3-P6 (A1)</option>
            <option value="A2.1 (S1-S2)">Niveau S1-S2 (A2.1)</option>
            <option value="A2.2 (S3)">Niveau S3 (A2.2)</option>
        </select>
    </div>

    <div class="topics-grid" id="topics-btns"></div>

    <div id="visual-stage">üëã</div>

    <div id="chat-box">
        <div class="message ai">Hi! I'm your tutor. Click the gear (‚öôÔ∏è) to add your API Key, then click the mic to talk!</div>
    </div>

    <div class="word-bank" id="word-bank"></div>

    <div class="controls">
        <button id="mic-btn">üé§</button>
        <div id="status" style="color: #666; font-size: 0.9rem;">Clique pour parler</div>
    </div>
</div>

<script>
    // --- CONFIGURATION R√âF√âRENTIEL ---
    const FIELDS = [
        { name: 'Identity', emoji: 'üë§', words: ["name", "age", "family", "live", "years old"] },
        { name: 'House', emoji: 'üè†', words: ["house", "bedroom", "kitchen", "garden", "pet"] },
        { name: 'Hobbies', emoji: '‚öΩ', words: ["sport", "music", "video games", "hobby", "play"] },
        { name: 'Travel', emoji: 'üö≤', words: ["train", "plane", "holiday", "beach", "city"] },
        { name: 'Health', emoji: 'üçé', words: ["head", "body", "happy", "tired", "doctor"] },
        { name: 'Shopping', emoji: 'üí∞', words: ["price", "money", "shop", "buy", "cost"] },
        { name: 'Food', emoji: 'üçï', words: ["breakfast", "lunch", "dinner", "apple", "water"] },
        { name: 'Time', emoji: '‚è∞', words: ["o'clock", "monday", "birthday", "summer", "weather"] }
    ];

    let currentTopic = FIELDS[0];
    let apiKey = localStorage.getItem('gemini_key') || "";
    let score = parseInt(localStorage.getItem('fwb_score')) || 0;
    document.getElementById('score-val').innerText = score;

    // --- INITIALISATION UI ---
    const topicContainer = document.getElementById('topics-btns');
    FIELDS.forEach((f, index) => {
        const btn = document.createElement('button');
        btn.className = `topic-btn ${index === 0 ? 'active' : ''}`;
        btn.innerHTML = `${f.emoji}<br>${f.name}`;
        btn.onclick = () => {
            currentTopic = f;
            document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('visual-stage').innerText = f.emoji;
            addMessage(`Switched to topic: ${f.name}.`, 'ai');
        };
        topicContainer.appendChild(btn);
    });

    // --- RECONNAISSANCE VOCALE ---
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    document.getElementById('mic-btn').onclick = () => {
        if (!apiKey) {
            alert("‚ö†Ô∏è Clique sur la roue dent√©e (‚öôÔ∏è) pour entrer ta cl√© API !");
            return;
        }
        recognition.start();
        document.getElementById('mic-btn').classList.add('listening');
        document.getElementById('status').innerText = "Je t'√©coute...";
    };

    recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        addMessage(text, 'user');
        callGemini(text);
    };

    recognition.onend = () => {
        document.getElementById('mic-btn').classList.remove('listening');
        document.getElementById('status').innerText = "Clique pour parler";
    };

    // --- APPEL API GEMINI ---
    async function callGemini(userText) {
        const level = document.getElementById('level-select').value;
        // Utilisation de la version v1beta qui est la plus robuste pour Flash
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

        const prompt = `Act as a friendly English Tutor for a student (Level: ${level}). 
        Current Topic: ${currentTopic.name}. 
        Student said: "${userText}". 
        INSTRUCTIONS: 
        1. If there's an error, say "You said... but it's better to say...".
        2. If correct, say "Well done!". 
        3. Always ask one short question about ${currentTopic.name} to continue.
        4. Use very simple English. Maximum 20 words.`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();

            if (data.error) {
                addMessage(`API ERROR: ${data.error.message}`, 'error-msg');
                return;
            }

            const aiReply = data.candidates[0].content.parts[0].text;
            addMessage(aiReply, 'ai');
            speak(aiReply);
            updateScore(10);
        } catch (err) {
            addMessage("Connection error. Try again.", "error-msg");
        }
    }

    // --- FONCTIONS AUXILIAIRES ---
    function addMessage(text, type) {
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        
        // D√©tection de mots cl√©s pour la Word Bank
        let highlightedText = text;
        current
